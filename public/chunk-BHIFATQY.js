import{a as y}from"./chunk-HUYOMWR4.js";import{Fa as v,Gb as u,R as b,X as g,a as $,b as I,f as Q,t as j}from"./chunk-Q6JVZMQ3.js";var M=class p{http=g(y);#t=v({loading:!0,planificacion:[]});planificacion=u(()=>this.#t().planificacion);loading=u(()=>this.#t().loading);ruta="https://mysticconnectserver-production.up.railway.app/api";constructor(){this.cargarPlanificacion()}cargarPlanificacion(){this.http.get(`${this.ruta}/planificacion`).subscribe(e=>{this.#t.set({loading:!1,planificacion:e}),console.log(e)})}NuevaPlanificacion=e=>Q(this,null,function*(){this.#t.set(I($({},this.#t()),{loading:!0})),this.http.post(`${this.ruta}/planificacion`,e).subscribe(n=>{console.log(e),this.#t.set(I($({},this.#t()),{loading:!1,planificacion:[...this.#t().planificacion,n]}))})});static \u0275fac=function(n){return new(n||p)};static \u0275prov=b({token:p,factory:p.\u0275fac,providedIn:"root"})};var S=class p{http=g(y);#t=v({loading:!0,reportes:[]});reportes=u(()=>this.#t().reportes);loading=u(()=>this.#t().loading);planificacionService=g(M);ruta="https://mysticconnectserver-production.up.railway.app/api";NoCapilares=["67a4c7cf083a2a1da67922a3","676c251affcb9efdbafe02d6","67a4c7ea083a2a1da67922a5"];constructor(){}cargarReportes(){this.http.get(`${this.ruta}/reportes`).subscribe(e=>{this.#t.set({loading:!1,reportes:e})})}cargarReportes_(e,n){return this.http.get(`${this.ruta}/reportes?inicio=${e}&fin=${n}`)}BuscarPorID(e){return this.http.get(`${this.ruta}/reportes/${e}`)}getReportesAgrupados_(e,n,l){return this.http.get(`${this.ruta}/reportes?inicio=${n}&fin=${l}`).pipe(j(m=>{let R=m.reduce((a,t)=>{let i=t.promotora?._id,f=t.cliente?.cliente;if(!i||t.promotora.fija!==e)return a;a[i]||(a[i]={promotora:`${t.promotora.nombre} ${t.promotora.apellido}`,marca:t.promotora.marca,sueldo:t.promotora.sueldo,region:t.promotora.region,porcentajeRebranding:0,porcentajeCapilares:0,puntosAcumulados:0,totalGastado:0,productosVendidos:0,conteoMetaUnidades:0,conteoMetaUnidadesQ:0,productosMystic:0,productosQerametik:0,puntosMystic:0,puntosQerametik:0,totalImpulsos:0,totalEventos:0,totalImpulsos_qerametik:0,totalEventos_qerametik:0,dias_impulto_mystic:0,dias_evento_mystic:0,dias_impulso_qerametik:0,dias_evento_qerametik:0,gastosPorMarca:{Mystic:0,Qerametik:0},clientes_atendidos:0,reportes:[],clientesRegistrados:new Set}),a[i].clientesRegistrados.has(f)||(a[i].clientes_atendidos+=1,a[i].clientesRegistrados.add(f)),t.productos.forEach(o=>{let r=o.producto.marca;a[i].gastosPorMarca[r]||(a[i].gastosPorMarca[r]=0),a[i].gastosPorMarca[r]+=o.producto.precio*o.cantidad});let s=t.productos.reduce((o,r)=>o+r.producto.puntos*r.cantidad,0),h=t.productos.reduce((o,r)=>o+r.producto.precio*r.cantidad,0),_=t.productos.reduce((o,r)=>o+r.cantidad,0),k=t.productos.reduce((o,r)=>o+(r.cantidad>=10?1:0),0),c=0,d=0;return t.productos.forEach(o=>{o.producto.marca==="Mystic"?(a[i].productosMystic+=o.cantidad,a[i].puntosMystic+=o.producto.puntos*o.cantidad,t.tipo==="Impulso"?a[i].totalImpulsos+=o.cantidad:t.tipo==="Evento"&&(a[i].totalEventos+=o.cantidad),o.producto.linea==="Rebranding"&&(a[i].porcentajeRebranding+=o.cantidad)):o.producto.marca==="Qerametik"&&(a[i].productosQerametik+=o.cantidad,a[i].puntosQerametik+=o.producto.puntos*o.cantidad,o.producto._id&&(this.NoCapilares.includes(o.producto._id)||(a[i].porcentajeCapilares+=o.cantidad)),t.tipo==="Impulso"?a[i].totalImpulsos_qerametik+=o.cantidad:t.tipo==="Evento"&&(a[i].totalEventos_qerametik+=o.cantidad))}),t.productos[0]&&(t.promotora.fija===!0?t.tipo==="Impulso"?t.productos[0].producto.marca==="Mystic"?s>=this.planificacionService.planificacion()[1].metas.tradicional.mystic.impulso&&(a[i].conteoMetaUnidades+=1):s>=this.planificacionService.planificacion()[1].metas.tradicional.qerametik.impulso&&(a[i].conteoMetaUnidadesQ+=1):t.productos[0].producto.marca==="Mystic"?s>=this.planificacionService.planificacion()[1].metas.tradicional.mystic.evento&&(a[i].conteoMetaUnidades+=1):s>=this.planificacionService.planificacion()[1].metas.tradicional.qerametik.evento&&(a[i].conteoMetaUnidadesQ+=1):t.tipo==="Impulso"?t.productos[0].producto.marca==="Mystic"?s>=this.planificacionService.planificacion()[1].metas.rebranding.mystic.impulso&&(a[i].conteoMetaUnidades+=1):s>=this.planificacionService.planificacion()[1].metas.rebranding.qerametik.impulso&&(a[i].conteoMetaUnidadesQ+=1):t.productos[0].producto.marca==="Mystic"?s>=this.planificacionService.planificacion()[1].metas.rebranding.mystic.evento&&(a[i].conteoMetaUnidades+=1):s>=this.planificacionService.planificacion()[1].metas.rebranding.qerametik.evento&&(a[i].conteoMetaUnidadesQ+=1)),a[i].puntosAcumulados+=s,a[i].totalGastado+=h,a[i].productosVendidos+=_,a[i].reportes.push({cliente:t.cliente.cliente,marca:t.cliente.marca,tipo:t.tipo,observacion:t.observacion,productos:t.productos.map(o=>({producto:o.producto.producto,puntos:o.producto.puntos,linea:o.producto.linea,marca:o.producto.marca,cantidad:o.cantidad,inicio:o.inicio,final:o.final,subtotal:o.producto.precio*o.cantidad,puntosTotales:o.producto.puntos*o.cantidad})),fecha:t.fecha,totalPuntos:s,totalSubtotal:h}),a},{});return Object.values(R).sort((a,t)=>t.productosVendidos-a.productosVendidos)}))}getReportesAgrupados(e,n,l){return console.log(e),this.http.get(`${this.ruta}/reportes?inicio=${n}&fin=${l}`).pipe(j(m=>{let R=m.reduce((a,t)=>{let i=t.promotora?._id;if(!i||t.promotora.fija!==e)return a;a[i]||(a[i]={promotora:`${t.promotora.nombre} ${t.promotora.apellido}`,marca:t.promotora.marca,sueldo:t.promotora.sueldo,region:t.promotora.region,porcentajeRebranding:0,porcentajeCapilares:0,puntosAcumulados:0,totalGastado:0,productosVendidos:0,conteoMetaUnidades:0,conteoMetaUnidadesQ:0,productosMystic:0,productosQerametik:0,puntosMystic:0,puntosQerametik:0,totalImpulsos:0,totalEventos:0,totalImpulsos_qerametik:0,totalEventos_qerametik:0,dias_impulto_mystic:0,dias_evento_mystic:0,dias_impulso_qerametik:0,dias_evento_qerametik:0,gastosPorMarca:{Mystic:0,Qerametik:0},clientes_atendidos:0,reportes:[]});let f=t.productos.reduce((c,d)=>c+d.producto.puntos*d.cantidad,0),s=t.productos.reduce((c,d)=>c+d.producto.precio*d.cantidad,0),h=t.productos.reduce((c,d)=>c+d.cantidad,0),_=0,k=0;return t.productos.forEach(c=>{c.producto.marca==="Mystic"?(a[i].productosMystic+=c.cantidad,a[i].puntosMystic+=c.producto.puntos*c.cantidad,c.producto.linea==="Tradicional"?_+=c.cantidad:c.producto.linea==="Rebranding"&&(k+=c.cantidad)):c.producto.marca==="Qerametik"&&(a[i].productosQerametik+=c.cantidad,a[i].puntosQerametik+=c.producto.puntos*c.cantidad)}),a[i].puntosAcumulados+=f,a[i].totalGastado+=s,a[i].productosVendidos+=h,a[i].porcentajeRebranding=k/a[i].productosMystic*100,a[i].reportes.push({cliente:t.cliente.cliente,marca:t.cliente.marca,tipo:t.tipo,observacion:t.observacion,productos:t.productos.map(c=>({producto:c.producto.producto,puntos:c.producto.puntos,linea:c.producto.linea,marca:c.producto.marca,cantidad:c.cantidad,inicio:c.inicio,final:c.final,subtotal:c.producto.precio*c.cantidad,puntosTotales:c.producto.puntos*c.cantidad})),fecha:t.fecha,totalPuntos:f,totalSubtotal:s}),a},{});return Object.values(R).sort((a,t)=>t.productosVendidos-a.productosVendidos)}))}NuevoReporte(e){this.http.post(`${this.ruta}/reportes`,e).subscribe(n=>{this.cargarReportes()})}formatFecha(e){let n=("0"+e.getDate()).slice(-2),l=("0"+(e.getMonth()+1)).slice(-2),m=e.getFullYear();return`${n}/${l}/${m}`}static \u0275fac=function(n){return new(n||p)};static \u0275prov=b({token:p,factory:p.\u0275fac,providedIn:"root"})};export{M as a,S as b};
