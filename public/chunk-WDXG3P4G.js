import{a as M}from"./chunk-TZTC4YCF.js";import{Fa as v,Fb as u,R as b,X as g,a as $,b as I,f as Q,t as j}from"./chunk-BH4UYFV3.js";var y=class p{http=g(M);#t=v({loading:!0,planificacion:[]});planificacion=u(()=>this.#t().planificacion);loading=u(()=>this.#t().loading);ruta="https://mysticconnect-server.onrender.com/api";constructor(){this.cargarPlanificacion()}cargarPlanificacion(){this.http.get(`${this.ruta}/planificacion`).subscribe(e=>{this.#t.set({loading:!1,planificacion:e}),console.log(e)})}NuevaPlanificacion=e=>Q(this,null,function*(){this.#t.set(I($({},this.#t()),{loading:!0})),this.http.post(`${this.ruta}/planificacion`,e).subscribe(n=>{console.log(e),this.#t.set(I($({},this.#t()),{loading:!1,planificacion:[...this.#t().planificacion,n]}))})});static \u0275fac=function(n){return new(n||p)};static \u0275prov=b({token:p,factory:p.\u0275fac,providedIn:"root"})};var S=class p{http=g(M);#t=v({loading:!0,reportes:[]});reportes=u(()=>this.#t().reportes);loading=u(()=>this.#t().loading);planificacionService=g(y);ruta="https://mysticconnect-server.onrender.com/api";NoCapilares=["67a4c7cf083a2a1da67922a3","676c251affcb9efdbafe02d6","67a4c7ea083a2a1da67922a5"];constructor(){}cargarReportes(){this.http.get(`${this.ruta}/reportes`).subscribe(e=>{this.#t.set({loading:!1,reportes:e})})}cargarReportes_(e,n){return this.http.get(`${this.ruta}/reportes?inicio=${e}&fin=${n}`)}BuscarPorID(e){return this.http.get(`${this.ruta}/reportes/${e}`)}getReportesAgrupados_(e,n,l){return this.http.get(`${this.ruta}/reportes?inicio=${n}&fin=${l}`).pipe(j(m=>{let R=m.reduce((a,t)=>{let o=t.promotora?._id,f=t.cliente?.cliente;if(!o||t.promotora.fija!==e)return a;a[o]||(a[o]={promotora:`${t.promotora.nombre} ${t.promotora.apellido}`,marca:t.promotora.marca,sueldo:t.promotora.sueldo,region:t.promotora.region,porcentajeRebranding:0,porcentajeCapilares:0,puntosAcumulados:0,totalGastado:0,productosVendidos:0,conteoMetaUnidades:0,conteoMetaUnidadesQ:0,productosMystic:0,productosQerametik:0,puntosMystic:0,puntosQerametik:0,totalImpulsos:0,totalEventos:0,totalImpulsos_qerametik:0,totalEventos_qerametik:0,dias_impulto_mystic:0,dias_evento_mystic:0,dias_impulso_qerametik:0,dias_evento_qerametik:0,gastosPorMarca:{Mystic:0,Qerametik:0},clientes_atendidos:0,reportes:[],clientesRegistrados:new Set}),a[o].clientesRegistrados.has(f)||(a[o].clientes_atendidos+=1,a[o].clientesRegistrados.add(f)),t.productos.forEach(i=>{let r=i.producto.marca;a[o].gastosPorMarca[r]||(a[o].gastosPorMarca[r]=0),a[o].gastosPorMarca[r]+=i.producto.precio*i.cantidad});let s=t.productos.reduce((i,r)=>i+r.producto.puntos*r.cantidad,0),h=t.productos.reduce((i,r)=>i+r.producto.precio*r.cantidad,0),_=t.productos.reduce((i,r)=>i+r.cantidad,0),k=t.productos.reduce((i,r)=>i+(r.cantidad>=10?1:0),0),c=0,d=0;return t.productos.forEach(i=>{i.producto.marca==="Mystic"?(a[o].productosMystic+=i.cantidad,a[o].puntosMystic+=i.producto.puntos*i.cantidad,t.tipo==="Impulso"?a[o].totalImpulsos+=i.cantidad:t.tipo==="Evento"&&(a[o].totalEventos+=i.cantidad),i.producto.linea==="Rebranding"&&(a[o].porcentajeRebranding+=i.cantidad)):i.producto.marca==="Qerametik"&&(a[o].productosQerametik+=i.cantidad,a[o].puntosQerametik+=i.producto.puntos*i.cantidad,i.producto._id&&(this.NoCapilares.includes(i.producto._id)||(a[o].porcentajeCapilares+=i.cantidad)),t.tipo==="Impulso"?a[o].totalImpulsos_qerametik+=i.cantidad:t.tipo==="Evento"&&(a[o].totalEventos_qerametik+=i.cantidad))}),t.productos[0]&&(t.promotora.fija===!0?t.tipo==="Impulso"?t.productos[0].producto.marca==="Mystic"?s>=this.planificacionService.planificacion()[1].metas.tradicional.mystic.impulso&&(a[o].conteoMetaUnidades+=1):s>=this.planificacionService.planificacion()[1].metas.tradicional.qerametik.impulso&&(a[o].conteoMetaUnidadesQ+=1):t.productos[0].producto.marca==="Mystic"?s>=this.planificacionService.planificacion()[1].metas.tradicional.mystic.evento&&(a[o].conteoMetaUnidades+=1):s>=this.planificacionService.planificacion()[1].metas.tradicional.qerametik.evento&&(a[o].conteoMetaUnidadesQ+=1):t.tipo==="Impulso"?t.productos[0].producto.marca==="Mystic"?s>=this.planificacionService.planificacion()[1].metas.rebranding.mystic.impulso&&(a[o].conteoMetaUnidades+=1):s>=this.planificacionService.planificacion()[1].metas.rebranding.qerametik.impulso&&(a[o].conteoMetaUnidadesQ+=1):t.productos[0].producto.marca==="Mystic"?s>=this.planificacionService.planificacion()[1].metas.rebranding.mystic.evento&&(a[o].conteoMetaUnidades+=1):s>=this.planificacionService.planificacion()[1].metas.rebranding.qerametik.evento&&(a[o].conteoMetaUnidadesQ+=1)),a[o].puntosAcumulados+=s,a[o].totalGastado+=h,a[o].productosVendidos+=_,a[o].reportes.push({cliente:t.cliente.cliente,marca:t.cliente.marca,tipo:t.tipo,observacion:t.observacion,productos:t.productos.map(i=>({producto:i.producto.producto,puntos:i.producto.puntos,linea:i.producto.linea,marca:i.producto.marca,cantidad:i.cantidad,inicio:i.inicio,final:i.final,subtotal:i.producto.precio*i.cantidad,puntosTotales:i.producto.puntos*i.cantidad})),fecha:t.fecha,totalPuntos:s,totalSubtotal:h}),a},{});return Object.values(R).sort((a,t)=>t.productosVendidos-a.productosVendidos)}))}getReportesAgrupados(e,n,l){return console.log(e),this.http.get(`${this.ruta}/reportes?inicio=${n}&fin=${l}`).pipe(j(m=>{let R=m.reduce((a,t)=>{let o=t.promotora?._id;if(!o||t.promotora.fija!==e)return a;a[o]||(a[o]={promotora:`${t.promotora.nombre} ${t.promotora.apellido}`,marca:t.promotora.marca,sueldo:t.promotora.sueldo,region:t.promotora.region,porcentajeRebranding:0,porcentajeCapilares:0,puntosAcumulados:0,totalGastado:0,productosVendidos:0,conteoMetaUnidades:0,conteoMetaUnidadesQ:0,productosMystic:0,productosQerametik:0,puntosMystic:0,puntosQerametik:0,totalImpulsos:0,totalEventos:0,totalImpulsos_qerametik:0,totalEventos_qerametik:0,dias_impulto_mystic:0,dias_evento_mystic:0,dias_impulso_qerametik:0,dias_evento_qerametik:0,gastosPorMarca:{Mystic:0,Qerametik:0},clientes_atendidos:0,reportes:[]});let f=t.productos.reduce((c,d)=>c+d.producto.puntos*d.cantidad,0),s=t.productos.reduce((c,d)=>c+d.producto.precio*d.cantidad,0),h=t.productos.reduce((c,d)=>c+d.cantidad,0),_=0,k=0;return t.productos.forEach(c=>{c.producto.marca==="Mystic"?(a[o].productosMystic+=c.cantidad,a[o].puntosMystic+=c.producto.puntos*c.cantidad,c.producto.linea==="Tradicional"?_+=c.cantidad:c.producto.linea==="Rebranding"&&(k+=c.cantidad)):c.producto.marca==="Qerametik"&&(a[o].productosQerametik+=c.cantidad,a[o].puntosQerametik+=c.producto.puntos*c.cantidad)}),a[o].puntosAcumulados+=f,a[o].totalGastado+=s,a[o].productosVendidos+=h,a[o].porcentajeRebranding=k/a[o].productosMystic*100,a[o].reportes.push({cliente:t.cliente.cliente,marca:t.cliente.marca,tipo:t.tipo,observacion:t.observacion,productos:t.productos.map(c=>({producto:c.producto.producto,puntos:c.producto.puntos,linea:c.producto.linea,marca:c.producto.marca,cantidad:c.cantidad,inicio:c.inicio,final:c.final,subtotal:c.producto.precio*c.cantidad,puntosTotales:c.producto.puntos*c.cantidad})),fecha:t.fecha,totalPuntos:f,totalSubtotal:s}),a},{});return Object.values(R).sort((a,t)=>t.productosVendidos-a.productosVendidos)}))}NuevoReporte(e){this.http.post(`${this.ruta}/reportes`,e).subscribe(n=>{this.cargarReportes()})}formatFecha(e){let n=("0"+e.getDate()).slice(-2),l=("0"+(e.getMonth()+1)).slice(-2),m=e.getFullYear();return`${n}/${l}/${m}`}static \u0275fac=function(n){return new(n||p)};static \u0275prov=b({token:p,factory:p.\u0275fac,providedIn:"root"})};export{y as a,S as b};
