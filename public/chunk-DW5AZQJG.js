import{a as b}from"./chunk-TA66JFPR.js";import{a as g}from"./chunk-HUNMWK37.js";import{Fa as v,Gb as m,R as h,X as f,t as u}from"./chunk-5XISTBJQ.js";var S=class l{http=f(g);#i=v({loading:!0,reportes:[]});reportes=m(()=>this.#i().reportes);loading=m(()=>this.#i().loading);planificacionService=f(b);ruta="https://mysticconnectserver-production.up.railway.app/api";constructor(){this.cargarReportes()}cargarReportes(){this.http.get(`${this.ruta}/reportes`).subscribe(e=>{this.#i.set({loading:!1,reportes:e})})}getReportesAgrupados_(e){return this.http.get(`${this.ruta}/reportes`).pipe(u(p=>{let t=p.reduce((i,o)=>{let n=o.promotora?._id;if(!n)return console.warn("Reporte sin promotora v\xE1lida:",o),i;if(o.promotora.fija!==e)return i;i[n]||(i[n]={promotora:`${o.promotora.nombre} ${o.promotora.apellido}`,puntosAcumulados:0,totalGastado:0,productosVendidos:0,conteoMetaUnidades:0,productosMystic:0,productosQerametik:0,puntosMystic:0,puntosQerametik:0,reportes:[]});let d=o.productos.reduce((c,r)=>c+r.producto.puntos*r.cantidad,0),s=o.productos.reduce((c,r)=>c+r.producto.precio*r.cantidad,0),a=o.productos.reduce((c,r)=>c+r.cantidad,0);return o.productos.forEach(c=>{c.producto.marca==="Mystic"?(i[n].productosMystic+=c.cantidad,i[n].puntosMystic+=c.producto.puntos*c.cantidad):c.producto.marca==="Qerametik"&&(i[n].productosQerametik+=c.cantidad,i[n].puntosQerametik+=c.producto.puntos*c.cantidad)}),o.promotora.fija===!0?o.tipo==="Impulso"?o.productos[0].producto.marca==="Mystic"?a>=this.planificacionService.planificacion()[this.planificacionService.planificacion().length-1].metas.tradicional.mystic.impulso&&(i[n].conteoMetaUnidades+=1):a>=this.planificacionService.planificacion()[this.planificacionService.planificacion().length-1].metas.tradicional.qerametik.impulso&&(i[n].conteoMetaUnidades+=1):o.productos[0].producto.marca==="Mystic"?a>=this.planificacionService.planificacion()[this.planificacionService.planificacion().length-1].metas.tradicional.mystic.evento&&(i[n].conteoMetaUnidades+=1):a>=this.planificacionService.planificacion()[this.planificacionService.planificacion().length-1].metas.tradicional.qerametik.evento&&(i[n].conteoMetaUnidades+=1):o.tipo==="Impulso"?o.productos[0].producto.marca==="Mystic"?a>=this.planificacionService.planificacion()[this.planificacionService.planificacion().length-1].metas.rebranding.mystic.impulso&&(i[n].conteoMetaUnidades+=1):a>=this.planificacionService.planificacion()[this.planificacionService.planificacion().length-1].metas.rebranding.qerametik.impulso&&(i[n].conteoMetaUnidades+=1):o.productos[0].producto.marca==="Mystic"?a>=this.planificacionService.planificacion()[this.planificacionService.planificacion().length-1].metas.rebranding.mystic.evento&&(i[n].conteoMetaUnidades+=1):a>=this.planificacionService.planificacion()[this.planificacionService.planificacion().length-1].metas.rebranding.qerametik.evento&&(i[n].conteoMetaUnidades+=1),i[n].puntosAcumulados+=d,i[n].totalGastado+=s,i[n].productosVendidos+=a,i[n].reportes.push({cliente:o.cliente.cliente,marca:o.cliente.marca,tipo:o.tipo,observacion:o.observacion,productos:o.productos.map(c=>({producto:c.producto.producto,linea:c.producto.linea,marca:c.producto.marca,cantidad:c.cantidad,subtotal:c.producto.precio*c.cantidad,puntosTotales:c.producto.puntos*c.cantidad})),fecha:o.fecha,totalPuntos:d,totalSubtotal:s}),i},{});return Object.values(t).sort((i,o)=>o.productosVendidos-i.productosVendidos)}))}getReportesAgrupados(){return this.http.get(`${this.ruta}/reportes`).pipe(u(e=>{let p=e.reduce((t,i)=>{let o=i.promotora?._id;if(!o)return console.warn("Reporte sin promotora v\xE1lida:",i),t;t[o]||(t[o]={promotora:`${i.promotora.nombre} ${i.promotora.apellido}`,puntosAcumulados:0,totalGastado:0,productosVendidos:0,conteoMetaUnidades:0,productosMystic:0,productosQerametik:0,puntosMystic:0,puntosQerametik:0,reportes:[]});let n=i.productos.reduce((a,c)=>a+c.producto.puntos*c.cantidad,0),d=i.productos.reduce((a,c)=>a+c.producto.precio*c.cantidad,0),s=i.productos.reduce((a,c)=>a+c.cantidad,0);return i.productos.forEach(a=>{a.producto.marca==="Mystic"?(t[o].productosMystic+=a.cantidad,t[o].puntosMystic+=a.producto.puntos*a.cantidad):a.producto.marca==="Qerametik"&&(t[o].productosQerametik+=a.cantidad,t[o].puntosQerametik+=a.producto.puntos*a.cantidad)}),i.promotora.fija===!0?i.tipo==="Impulso"?i.productos[0].producto.marca==="Mystic"?s>=this.planificacionService.planificacion()[this.planificacionService.planificacion().length-1].metas.tradicional.mystic.impulso&&(t[o].conteoMetaUnidades+=1):s>=this.planificacionService.planificacion()[this.planificacionService.planificacion().length-1].metas.tradicional.qerametik.impulso&&(t[o].conteoMetaUnidades+=1):i.productos[0].producto.marca==="Mystic"?s>=this.planificacionService.planificacion()[this.planificacionService.planificacion().length-1].metas.tradicional.mystic.evento&&(t[o].conteoMetaUnidades+=1):s>=this.planificacionService.planificacion()[this.planificacionService.planificacion().length-1].metas.tradicional.qerametik.evento&&(t[o].conteoMetaUnidades+=1):i.tipo==="Impulso"?i.productos[0].producto.marca==="Mystic"?s>=this.planificacionService.planificacion()[this.planificacionService.planificacion().length-1].metas.rebranding.mystic.impulso&&(t[o].conteoMetaUnidades+=1):s>=this.planificacionService.planificacion()[this.planificacionService.planificacion().length-1].metas.rebranding.qerametik.impulso&&(t[o].conteoMetaUnidades+=1):i.productos[0].producto.marca==="Mystic"?s>=this.planificacionService.planificacion()[this.planificacionService.planificacion().length-1].metas.rebranding.mystic.evento&&(t[o].conteoMetaUnidades+=1):s>=this.planificacionService.planificacion()[this.planificacionService.planificacion().length-1].metas.rebranding.qerametik.evento&&(t[o].conteoMetaUnidades+=1),t[o].puntosAcumulados+=n,t[o].totalGastado+=d,t[o].productosVendidos+=s,t[o].reportes.push({cliente:i.cliente.cliente,marca:i.cliente.marca,tipo:i.tipo,observacion:i.observacion,productos:i.productos.map(a=>({producto:a.producto.producto,linea:a.producto.linea,marca:a.producto.marca,cantidad:a.cantidad,subtotal:a.producto.precio*a.cantidad,puntosTotales:a.producto.puntos*a.cantidad})),fecha:i.fecha,totalPuntos:n,totalSubtotal:d}),t},{});return Object.values(p).sort((t,i)=>i.productosVendidos-t.productosVendidos)}))}NuevoReporte(e){this.http.post(`${this.ruta}/reportes`,e).subscribe(p=>{this.cargarReportes()})}formatFecha(e){let p=("0"+e.getDate()).slice(-2),t=("0"+(e.getMonth()+1)).slice(-2),i=e.getFullYear();return`${p}/${t}/${i}`}static \u0275fac=function(p){return new(p||l)};static \u0275prov=h({token:l,factory:l.\u0275fac,providedIn:"root"})};export{S as a};
