import{a as R}from"./chunk-TZTC4YCF.js";import{Fa as v,Fb as u,R as h,X as g,a as S,b as $,f as A,t as I}from"./chunk-BH4UYFV3.js";var M=class p{http=g(R);#i=v({loading:!0,planificacion:[]});planificacion=u(()=>this.#i().planificacion);loading=u(()=>this.#i().loading);ruta="https://mysticconnect-server.onrender.com/api";constructor(){this.cargarPlanificacion()}cargarPlanificacion(){this.http.get(`${this.ruta}/planificacion`).subscribe(e=>{this.#i.set({loading:!1,planificacion:e}),console.log(e)})}NuevaPlanificacion=e=>A(this,null,function*(){this.#i.set($(S({},this.#i()),{loading:!0})),this.http.post(`${this.ruta}/planificacion`,e).subscribe(n=>{console.log(e),this.#i.set($(S({},this.#i()),{loading:!1,planificacion:[...this.#i().planificacion,n]}))})});static \u0275fac=function(n){return new(n||p)};static \u0275prov=h({token:p,factory:p.\u0275fac,providedIn:"root"})};var U=class p{http=g(R);#i=v({loading:!0,reportes:[]});reportes=u(()=>this.#i().reportes);loading=u(()=>this.#i().loading);planificacionService=g(M);ruta="https://mysticconnect-server.onrender.com/api";NoCapilares=["67a4c7cf083a2a1da67922a3","676c251affcb9efdbafe02d6","67a4c7ea083a2a1da67922a5"];constructor(){}cargarReportes(){this.http.get(`${this.ruta}/reportes`).subscribe(e=>{this.#i.set({loading:!1,reportes:e})})}cargarReportes_(e,n){return this.http.get(`${this.ruta}/reportes?inicio=${e}&fin=${n}`)}BuscarPorID(e){return this.http.get(`${this.ruta}/reportes/${e}`)}getReportesAgrupados_(e,n,l){return this.http.get(`${this.ruta}/reportes?inicio=${n}&fin=${l}`).pipe(I(m=>{let y=m.reduce((i,a)=>{let t=a.promotora?._id,f=a.cliente?.cliente;if(!t||a.promotora.fija!==e)return i;i[t]||(i[t]={promotora:`${a.promotora.nombre} ${a.promotora.apellido}`,marca:a.promotora.marca,sueldo:a.promotora.sueldo,region:a.promotora.region,porcentajeRebranding:0,porcentajeCapilares:0,diasSinRebranding:0,diasSinCapilares:0,puntosAcumulados:0,totalGastado:0,productosVendidos:0,conteoMetaUnidades:0,conteoMetaUnidadesQ:0,productosMystic:0,productosQerametik:0,puntosMystic:0,puntosQerametik:0,totalImpulsos:0,totalEventos:0,totalImpulsos_qerametik:0,totalEventos_qerametik:0,dias_impulto_mystic:0,dias_evento_mystic:0,dias_impulso_qerametik:0,dias_evento_qerametik:0,gastosPorMarca:{Mystic:0,Qerametik:0},clientes_atendidos:0,reportes:[],clientesRegistrados:new Set}),i[t].clientesRegistrados.has(f)||(i[t].clientes_atendidos+=1,i[t].clientesRegistrados.add(f)),a.productos.forEach(o=>{let r=o.producto.marca;i[t].gastosPorMarca[r]||(i[t].gastosPorMarca[r]=0),i[t].gastosPorMarca[r]+=o.producto.precio*o.cantidad});let s=a.productos.reduce((o,r)=>o+r.producto.puntos*r.cantidad,0),b=a.productos.reduce((o,r)=>o+r.producto.precio*r.cantidad,0),_=a.productos.reduce((o,r)=>o+r.cantidad,0),k=a.productos.reduce((o,r)=>o+(r.cantidad>=10?1:0),0),c=0,d=0,E=0,Q=!1,j=!1,P=!1,q=!1;return a.productos.forEach(o=>{o.producto.marca==="Mystic"?(i[t].productosMystic+=o.cantidad,i[t].puntosMystic+=o.producto.puntos*o.cantidad,a.tipo==="Impulso"?i[t].totalImpulsos+=o.cantidad:a.tipo==="Evento"&&(i[t].totalEventos+=o.cantidad),P=!0,o.producto.linea==="Rebranding"&&(o.producto.linea==="Rebranding"&&o.inicio!==0&&(j=!0),i[t].porcentajeRebranding+=o.cantidad)):o.producto.marca==="Qerametik"&&(i[t].productosQerametik+=o.cantidad,i[t].puntosQerametik+=o.producto.puntos*o.cantidad,q=!0,o.producto._id&&(this.NoCapilares.includes(o.producto._id)||(!this.NoCapilares.includes(o.producto._id)&&o.inicio!==0&&(Q=!0),i[t].porcentajeCapilares+=o.cantidad)),a.tipo==="Impulso"?i[t].totalImpulsos_qerametik+=o.cantidad:a.tipo==="Evento"&&(i[t].totalEventos_qerametik+=o.cantidad))}),P&&!j&&(i[t].diasSinRebranding+=1),q&&!Q&&(i[t].diasSinCapilares+=1),a.productos[0]&&(a.promotora.fija===!0?a.tipo==="Impulso"?a.productos[0].producto.marca==="Mystic"?s>=this.planificacionService.planificacion()[1].metas.tradicional.mystic.impulso&&(i[t].conteoMetaUnidades+=1):s>=this.planificacionService.planificacion()[1].metas.tradicional.qerametik.impulso&&(i[t].conteoMetaUnidadesQ+=1):a.productos[0].producto.marca==="Mystic"?s>=this.planificacionService.planificacion()[1].metas.tradicional.mystic.evento&&(i[t].conteoMetaUnidades+=1):s>=this.planificacionService.planificacion()[1].metas.tradicional.qerametik.evento&&(i[t].conteoMetaUnidadesQ+=1):a.tipo==="Impulso"?a.productos[0].producto.marca==="Mystic"?s>=this.planificacionService.planificacion()[1].metas.rebranding.mystic.impulso&&(i[t].conteoMetaUnidades+=1):s>=this.planificacionService.planificacion()[1].metas.rebranding.qerametik.impulso&&(i[t].conteoMetaUnidadesQ+=1):a.productos[0].producto.marca==="Mystic"?s>=this.planificacionService.planificacion()[1].metas.rebranding.mystic.evento&&(i[t].conteoMetaUnidades+=1):s>=this.planificacionService.planificacion()[1].metas.rebranding.qerametik.evento&&(i[t].conteoMetaUnidadesQ+=1)),i[t].puntosAcumulados+=s,i[t].totalGastado+=b,i[t].productosVendidos+=_,i[t].reportes.push({cliente:a.cliente.cliente,marca:a.cliente.marca,tipo:a.tipo,observacion:a.observacion,productos:a.productos.map(o=>({producto:o.producto.producto,puntos:o.producto.puntos,linea:o.producto.linea,marca:o.producto.marca,cantidad:o.cantidad,inicio:o.inicio,final:o.final,subtotal:o.producto.precio*o.cantidad,puntosTotales:o.producto.puntos*o.cantidad})),fecha:a.fecha,totalPuntos:s,totalSubtotal:b}),i},{});return Object.values(y).sort((i,a)=>a.productosVendidos-i.productosVendidos)}))}getReportesAgrupados(e,n,l){return console.log(e),this.http.get(`${this.ruta}/reportes?inicio=${n}&fin=${l}`).pipe(I(m=>{let y=m.reduce((i,a)=>{let t=a.promotora?._id;if(!t||a.promotora.fija!==e)return i;i[t]||(i[t]={promotora:`${a.promotora.nombre} ${a.promotora.apellido}`,marca:a.promotora.marca,sueldo:a.promotora.sueldo,region:a.promotora.region,porcentajeRebranding:0,porcentajeCapilares:0,diasSinRebranding:0,diasSinCapilares:0,puntosAcumulados:0,totalGastado:0,productosVendidos:0,conteoMetaUnidades:0,conteoMetaUnidadesQ:0,productosMystic:0,productosQerametik:0,puntosMystic:0,puntosQerametik:0,totalImpulsos:0,totalEventos:0,totalImpulsos_qerametik:0,totalEventos_qerametik:0,dias_impulto_mystic:0,dias_evento_mystic:0,dias_impulso_qerametik:0,dias_evento_qerametik:0,gastosPorMarca:{Mystic:0,Qerametik:0},clientes_atendidos:0,reportes:[]});let f=a.productos.reduce((c,d)=>c+d.producto.puntos*d.cantidad,0),s=a.productos.reduce((c,d)=>c+d.producto.precio*d.cantidad,0),b=a.productos.reduce((c,d)=>c+d.cantidad,0),_=0,k=0;return a.productos.forEach(c=>{c.producto.marca==="Mystic"?(i[t].productosMystic+=c.cantidad,i[t].puntosMystic+=c.producto.puntos*c.cantidad,c.producto.linea==="Tradicional"?_+=c.cantidad:c.producto.linea==="Rebranding"&&(k+=c.cantidad)):c.producto.marca==="Qerametik"&&(i[t].productosQerametik+=c.cantidad,i[t].puntosQerametik+=c.producto.puntos*c.cantidad)}),i[t].puntosAcumulados+=f,i[t].totalGastado+=s,i[t].productosVendidos+=b,i[t].porcentajeRebranding=k/i[t].productosMystic*100,i[t].reportes.push({cliente:a.cliente.cliente,marca:a.cliente.marca,tipo:a.tipo,observacion:a.observacion,productos:a.productos.map(c=>({producto:c.producto.producto,puntos:c.producto.puntos,linea:c.producto.linea,marca:c.producto.marca,cantidad:c.cantidad,inicio:c.inicio,final:c.final,subtotal:c.producto.precio*c.cantidad,puntosTotales:c.producto.puntos*c.cantidad})),fecha:a.fecha,totalPuntos:f,totalSubtotal:s}),i},{});return Object.values(y).sort((i,a)=>a.productosVendidos-i.productosVendidos)}))}NuevoReporte(e){this.http.post(`${this.ruta}/reportes`,e).subscribe(n=>{this.cargarReportes()})}formatFecha(e){let n=("0"+e.getDate()).slice(-2),l=("0"+(e.getMonth()+1)).slice(-2),m=e.getFullYear();return`${n}/${l}/${m}`}static \u0275fac=function(n){return new(n||p)};static \u0275prov=h({token:p,factory:p.\u0275fac,providedIn:"root"})};export{M as a,U as b};
