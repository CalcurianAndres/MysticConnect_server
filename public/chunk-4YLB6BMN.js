import{a as v}from"./chunk-TZTC4YCF.js";import{Fa as h,Fb as d,R as g,X as f,a as k,b as R,f as $,t as _}from"./chunk-BH4UYFV3.js";var b=class p{http=f(v);#o=h({loading:!0,planificacion:[]});planificacion=d(()=>this.#o().planificacion);loading=d(()=>this.#o().loading);ruta="https://mysticconnectserver-production.up.railway.app/api";constructor(){this.cargarPlanificacion()}cargarPlanificacion(){this.http.get(`${this.ruta}/planificacion`).subscribe(n=>{this.#o.set({loading:!1,planificacion:n}),console.log(n)})}NuevaPlanificacion=n=>$(this,null,function*(){this.#o.set(R(k({},this.#o()),{loading:!0})),this.http.post(`${this.ruta}/planificacion`,n).subscribe(e=>{console.log(n),this.#o.set(R(k({},this.#o()),{loading:!1,planificacion:[...this.#o().planificacion,e]}))})});static \u0275fac=function(e){return new(e||p)};static \u0275prov=g({token:p,factory:p.\u0275fac,providedIn:"root"})};var I=class p{http=f(v);#o=h({loading:!0,reportes:[]});reportes=d(()=>this.#o().reportes);loading=d(()=>this.#o().loading);planificacionService=f(b);ruta="https://mysticconnectserver-production.up.railway.app/api";constructor(){}cargarReportes(){this.http.get(`${this.ruta}/reportes`).subscribe(n=>{this.#o.set({loading:!1,reportes:n})})}cargarReportes_(n,e){return this.http.get(`${this.ruta}/reportes?inicio=${n}&fin=${e}`)}BuscarPorID(n){return this.http.get(`${this.ruta}/reportes/${n}`)}getReportesAgrupados_(n,e,u){return this.http.get(`${this.ruta}/reportes?inicio=${e}&fin=${u}`).pipe(_(l=>{let y=l.reduce((t,o)=>{let a=o.promotora?._id;if(!a)return console.warn("Reporte sin promotora v\xE1lida:",o),t;if(o.promotora.fija!==n)return console.warn("reportes que no coincidan con el tipoPromotora:",o),t;t[a]||(t[a]={promotora:`${o.promotora.nombre} ${o.promotora.apellido}`,marca:o.promotora.marca,region:o.promotora.region,puntosAcumulados:0,totalGastado:0,productosVendidos:0,conteoMetaUnidades:0,conteoMetaUnidadesQ:0,productosMystic:0,productosQerametik:0,puntosMystic:0,puntosQerametik:0,totalImpulsos:0,totalEventos:0,totalImpulsos_qerametik:0,totalEventos_qerametik:0,dias_impulto_mystic:0,dias_evento_mystic:0,dias_impulso_qerametik:0,dias_evento_qerametik:0,gastosPorMarca:{Mystic:0,Qerametik:0},reportes:[]}),o.productos.forEach(i=>{let r=i.producto.marca;t[a].gastosPorMarca[r]||(t[a].gastosPorMarca[r]=0),t[a].gastosPorMarca[r]+=i.producto.precio*i.cantidad});let s=o.productos.reduce((i,r)=>i+r.producto.puntos*r.cantidad,0),m=o.productos.reduce((i,r)=>i+r.producto.precio*r.cantidad,0),M=o.productos.reduce((i,r)=>i+r.cantidad,0),c=o.productos.reduce((i,r)=>i+(r.cantidad>=10?1:0),0);return o.productos.forEach(i=>{i.producto.marca==="Mystic"?(t[a].productosMystic+=i.cantidad,t[a].puntosMystic+=i.producto.puntos*i.cantidad,o.tipo==="Impulso"?t[a].totalImpulsos+=i.cantidad:o.tipo==="Evento"&&(t[a].totalEventos+=i.cantidad)):i.producto.marca==="Qerametik"&&(t[a].productosQerametik+=i.cantidad,t[a].puntosQerametik+=i.producto.puntos*i.cantidad,o.tipo==="Impulso"?t[a].totalImpulsos_qerametik+=i.cantidad:o.tipo==="Evento"&&(t[a].totalEventos_qerametik+=i.cantidad))}),o.productos[0]&&(o.promotora.fija===!0?o.tipo==="Impulso"?o.productos[0].producto.marca==="Mystic"?s>=this.planificacionService.planificacion()[1].metas.tradicional.mystic.impulso&&(t[a].conteoMetaUnidades+=1):s>=this.planificacionService.planificacion()[1].metas.tradicional.qerametik.impulso&&(t[a].conteoMetaUnidadesQ+=1):o.productos[0].producto.marca==="Mystic"?s>=this.planificacionService.planificacion()[1].metas.tradicional.mystic.evento&&(t[a].conteoMetaUnidades+=1):s>=this.planificacionService.planificacion()[1].metas.tradicional.qerametik.evento&&(t[a].conteoMetaUnidadesQ+=1):o.tipo==="Impulso"?o.productos[0].producto.marca==="Mystic"?s>=this.planificacionService.planificacion()[1].metas.rebranding.mystic.impulso&&(t[a].conteoMetaUnidades+=1):s>=this.planificacionService.planificacion()[1].metas.rebranding.qerametik.impulso&&(t[a].conteoMetaUnidadesQ+=1):o.productos[0].producto.marca==="Mystic"?s>=this.planificacionService.planificacion()[1].metas.rebranding.mystic.evento&&(t[a].conteoMetaUnidades+=1):s>=this.planificacionService.planificacion()[1].metas.rebranding.qerametik.evento&&(t[a].conteoMetaUnidadesQ+=1)),t[a].puntosAcumulados+=s,t[a].totalGastado+=m,t[a].productosVendidos+=M,t[a].reportes.push({cliente:o.cliente.cliente,marca:o.cliente.marca,tipo:o.tipo,observacion:o.observacion,productos:o.productos.map(i=>({producto:i.producto.producto,linea:i.producto.linea,marca:i.producto.marca,cantidad:i.cantidad,inicio:i.inicio,final:i.final,subtotal:i.producto.precio*i.cantidad,puntosTotales:i.producto.puntos*i.cantidad})),fecha:o.fecha,totalPuntos:s,totalSubtotal:m}),t},{});return Object.values(y).sort((t,o)=>o.productosVendidos-t.productosVendidos)}))}getReportesAgrupados(n,e,u){return console.log(n),this.http.get(`${this.ruta}/reportes?inicio=${e}&fin=${u}`).pipe(_(l=>{let y=l.reduce((t,o)=>{let a=o.promotora?._id;if(!a)return console.warn("Reporte sin promotora v\xE1lida:",o),t;if(o.promotora.fija!==n)return console.warn("reportes que no coincidan con el tipoPromotora:",o),t;t[a]||(t[a]={promotora:`${o.promotora.nombre} ${o.promotora.apellido}`,marca:o.promotora.marca,region:o.promotora.region,puntosAcumulados:0,totalGastado:0,productosVendidos:0,conteoMetaUnidades:0,conteoMetaUnidadesQ:0,productosMystic:0,productosQerametik:0,puntosMystic:0,puntosQerametik:0,totalImpulsos:0,totalEventos:0,totalImpulsos_qerametik:0,totalEventos_qerametik:0,dias_impulto_mystic:0,dias_evento_mystic:0,dias_impulso_qerametik:0,dias_evento_qerametik:0,gastosPorMarca:{Mystic:0,Qerametik:0},reportes:[]});let s=o.productos.reduce((c,i)=>c+i.producto.puntos*i.cantidad,0),m=o.productos.reduce((c,i)=>c+i.producto.precio*i.cantidad,0),M=o.productos.reduce((c,i)=>c+i.cantidad,0);return o.productos.forEach(c=>{c.producto.marca==="Mystic"?(t[a].productosMystic+=c.cantidad,t[a].puntosMystic+=c.producto.puntos*c.cantidad):c.producto.marca==="Qerametik"&&(t[a].productosQerametik+=c.cantidad,t[a].puntosQerametik+=c.producto.puntos*c.cantidad)}),t[a].puntosAcumulados+=s,t[a].totalGastado+=m,t[a].productosVendidos+=M,t[a].reportes.push({cliente:o.cliente.cliente,marca:o.cliente.marca,tipo:o.tipo,observacion:o.observacion,productos:o.productos.map(c=>({producto:c.producto.producto,linea:c.producto.linea,marca:c.producto.marca,cantidad:c.cantidad,inicio:c.inicio,final:c.final,subtotal:c.producto.precio*c.cantidad,puntosTotales:c.producto.puntos*c.cantidad})),fecha:o.fecha,totalPuntos:s,totalSubtotal:m}),t},{});return Object.values(y).sort((t,o)=>o.productosVendidos-t.productosVendidos)}))}NuevoReporte(n){this.http.post(`${this.ruta}/reportes`,n).subscribe(e=>{this.cargarReportes()})}formatFecha(n){let e=("0"+n.getDate()).slice(-2),u=("0"+(n.getMonth()+1)).slice(-2),l=n.getFullYear();return`${e}/${u}/${l}`}static \u0275fac=function(e){return new(e||p)};static \u0275prov=g({token:p,factory:p.\u0275fac,providedIn:"root"})};export{b as a,I as b};
