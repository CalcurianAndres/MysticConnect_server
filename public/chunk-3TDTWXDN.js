import{a as b}from"./chunk-HUYOMWR4.js";import{Fa as h,Gb as p,R as g,X as f,a as k,b as _,f as Q,t as $}from"./chunk-Q6JVZMQ3.js";var v=class d{http=f(b);#t=h({loading:!0,planificacion:[]});planificacion=p(()=>this.#t().planificacion);loading=p(()=>this.#t().loading);ruta="https://mysticconnectserver-production.up.railway.app/api";constructor(){this.cargarPlanificacion()}cargarPlanificacion(){this.http.get(`${this.ruta}/planificacion`).subscribe(n=>{this.#t.set({loading:!1,planificacion:n}),console.log(n)})}NuevaPlanificacion=n=>Q(this,null,function*(){this.#t.set(_(k({},this.#t()),{loading:!0})),this.http.post(`${this.ruta}/planificacion`,n).subscribe(e=>{console.log(n),this.#t.set(_(k({},this.#t()),{loading:!1,planificacion:[...this.#t().planificacion,e]}))})});static \u0275fac=function(e){return new(e||d)};static \u0275prov=g({token:d,factory:d.\u0275fac,providedIn:"root"})};var S=class d{http=f(b);#t=h({loading:!0,reportes:[]});reportes=p(()=>this.#t().reportes);loading=p(()=>this.#t().loading);planificacionService=f(v);ruta="https://mysticconnectserver-production.up.railway.app/api";constructor(){}cargarReportes(){this.http.get(`${this.ruta}/reportes`).subscribe(n=>{this.#t.set({loading:!1,reportes:n})})}cargarReportes_(n,e){return this.http.get(`${this.ruta}/reportes?inicio=${n}&fin=${e}`)}BuscarPorID(n){return this.http.get(`${this.ruta}/reportes/${n}`)}getReportesAgrupados_(n,e,u){return this.http.get(`${this.ruta}/reportes?inicio=${e}&fin=${u}`).pipe($(l=>{let y=l.reduce((o,t)=>{let a=t.promotora?._id;if(!a||t.promotora.fija!==n)return o;o[a]||(o[a]={promotora:`${t.promotora.nombre} ${t.promotora.apellido}`,marca:t.promotora.marca,sueldo:t.promotora.sueldo,region:t.promotora.region,porcentajeRebranding:0,puntosAcumulados:0,totalGastado:0,productosVendidos:0,conteoMetaUnidades:0,conteoMetaUnidadesQ:0,productosMystic:0,productosQerametik:0,puntosMystic:0,puntosQerametik:0,totalImpulsos:0,totalEventos:0,totalImpulsos_qerametik:0,totalEventos_qerametik:0,dias_impulto_mystic:0,dias_evento_mystic:0,dias_impulso_qerametik:0,dias_evento_qerametik:0,gastosPorMarca:{Mystic:0,Qerametik:0},reportes:[]}),t.productos.forEach(i=>{let r=i.producto.marca;o[a].gastosPorMarca[r]||(o[a].gastosPorMarca[r]=0),o[a].gastosPorMarca[r]+=i.producto.precio*i.cantidad});let s=t.productos.reduce((i,r)=>i+r.producto.puntos*r.cantidad,0),m=t.productos.reduce((i,r)=>i+r.producto.precio*r.cantidad,0),M=t.productos.reduce((i,r)=>i+r.cantidad,0),I=t.productos.reduce((i,r)=>i+(r.cantidad>=10?1:0),0),R=0,c=0;return t.productos.forEach(i=>{i.producto.marca==="Mystic"?(o[a].productosMystic+=i.cantidad,o[a].puntosMystic+=i.producto.puntos*i.cantidad,t.tipo==="Impulso"?o[a].totalImpulsos+=i.cantidad:t.tipo==="Evento"&&(o[a].totalEventos+=i.cantidad),i.producto.linea==="Rebranding"&&(o[a].porcentajeRebranding+=i.cantidad)):i.producto.marca==="Qerametik"&&(o[a].productosQerametik+=i.cantidad,o[a].puntosQerametik+=i.producto.puntos*i.cantidad,t.tipo==="Impulso"?o[a].totalImpulsos_qerametik+=i.cantidad:t.tipo==="Evento"&&(o[a].totalEventos_qerametik+=i.cantidad))}),t.productos[0]&&(t.promotora.fija===!0?t.tipo==="Impulso"?t.productos[0].producto.marca==="Mystic"?s>=this.planificacionService.planificacion()[1].metas.tradicional.mystic.impulso&&(o[a].conteoMetaUnidades+=1):s>=this.planificacionService.planificacion()[1].metas.tradicional.qerametik.impulso&&(o[a].conteoMetaUnidadesQ+=1):t.productos[0].producto.marca==="Mystic"?s>=this.planificacionService.planificacion()[1].metas.tradicional.mystic.evento&&(o[a].conteoMetaUnidades+=1):s>=this.planificacionService.planificacion()[1].metas.tradicional.qerametik.evento&&(o[a].conteoMetaUnidadesQ+=1):t.tipo==="Impulso"?t.productos[0].producto.marca==="Mystic"?s>=this.planificacionService.planificacion()[1].metas.rebranding.mystic.impulso&&(o[a].conteoMetaUnidades+=1):s>=this.planificacionService.planificacion()[1].metas.rebranding.qerametik.impulso&&(o[a].conteoMetaUnidadesQ+=1):t.productos[0].producto.marca==="Mystic"?s>=this.planificacionService.planificacion()[1].metas.rebranding.mystic.evento&&(o[a].conteoMetaUnidades+=1):s>=this.planificacionService.planificacion()[1].metas.rebranding.qerametik.evento&&(o[a].conteoMetaUnidadesQ+=1)),o[a].puntosAcumulados+=s,o[a].totalGastado+=m,o[a].productosVendidos+=M,o[a].reportes.push({cliente:t.cliente.cliente,marca:t.cliente.marca,tipo:t.tipo,observacion:t.observacion,productos:t.productos.map(i=>({producto:i.producto.producto,puntos:i.producto.puntos,linea:i.producto.linea,marca:i.producto.marca,cantidad:i.cantidad,inicio:i.inicio,final:i.final,subtotal:i.producto.precio*i.cantidad,puntosTotales:i.producto.puntos*i.cantidad})),fecha:t.fecha,totalPuntos:s,totalSubtotal:m}),o},{});return Object.values(y).sort((o,t)=>t.productosVendidos-o.productosVendidos)}))}getReportesAgrupados(n,e,u){return console.log(n),this.http.get(`${this.ruta}/reportes?inicio=${e}&fin=${u}`).pipe($(l=>{let y=l.reduce((o,t)=>{let a=t.promotora?._id;if(!a||t.promotora.fija!==n)return o;o[a]||(o[a]={promotora:`${t.promotora.nombre} ${t.promotora.apellido}`,marca:t.promotora.marca,sueldo:t.promotora.sueldo,region:t.promotora.region,porcentajeRebranding:0,puntosAcumulados:0,totalGastado:0,productosVendidos:0,conteoMetaUnidades:0,conteoMetaUnidadesQ:0,productosMystic:0,productosQerametik:0,puntosMystic:0,puntosQerametik:0,totalImpulsos:0,totalEventos:0,totalImpulsos_qerametik:0,totalEventos_qerametik:0,dias_impulto_mystic:0,dias_evento_mystic:0,dias_impulso_qerametik:0,dias_evento_qerametik:0,gastosPorMarca:{Mystic:0,Qerametik:0},reportes:[]});let s=t.productos.reduce((c,i)=>c+i.producto.puntos*i.cantidad,0),m=t.productos.reduce((c,i)=>c+i.producto.precio*i.cantidad,0),M=t.productos.reduce((c,i)=>c+i.cantidad,0),I=0,R=0;return t.productos.forEach(c=>{c.producto.marca==="Mystic"?(o[a].productosMystic+=c.cantidad,o[a].puntosMystic+=c.producto.puntos*c.cantidad,c.producto.linea==="Tradicional"?I+=c.cantidad:c.producto.linea==="Rebranding"&&(R+=c.cantidad)):c.producto.marca==="Qerametik"&&(o[a].productosQerametik+=c.cantidad,o[a].puntosQerametik+=c.producto.puntos*c.cantidad)}),o[a].puntosAcumulados+=s,o[a].totalGastado+=m,o[a].productosVendidos+=M,o[a].porcentajeRebranding=R/o[a].productosMystic*100,o[a].reportes.push({cliente:t.cliente.cliente,marca:t.cliente.marca,tipo:t.tipo,observacion:t.observacion,productos:t.productos.map(c=>({producto:c.producto.producto,puntos:c.producto.puntos,linea:c.producto.linea,marca:c.producto.marca,cantidad:c.cantidad,inicio:c.inicio,final:c.final,subtotal:c.producto.precio*c.cantidad,puntosTotales:c.producto.puntos*c.cantidad})),fecha:t.fecha,totalPuntos:s,totalSubtotal:m}),o},{});return Object.values(y).sort((o,t)=>t.productosVendidos-o.productosVendidos)}))}NuevoReporte(n){this.http.post(`${this.ruta}/reportes`,n).subscribe(e=>{this.cargarReportes()})}formatFecha(n){let e=("0"+n.getDate()).slice(-2),u=("0"+(n.getMonth()+1)).slice(-2),l=n.getFullYear();return`${e}/${u}/${l}`}static \u0275fac=function(e){return new(e||d)};static \u0275prov=g({token:d,factory:d.\u0275fac,providedIn:"root"})};export{v as a,S as b};
